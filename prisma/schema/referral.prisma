// ============================================
// MarchesBTP - Models Parrainage
// MVP2 : Systeme de parrainage
// ============================================

model Referral {
  id              Int             @id @default(autoincrement())
  
  // Parrain
  referrerId      Int             @map("referrer_id")
  referrerType    String          @map("referrer_type")
  
  // Filleul
  referredId      Int             @map("referred_id")
  referredType    String          @map("referred_type")
  
  // Code utilise
  referralCode    String          @map("referral_code")
  
  // Statut
  status          ReferralStatus  @default(PENDING)
  
  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  validatedAt     DateTime?       @map("validated_at")
  
  // Relations
  rewards         ReferralReward[]

  @@map("referrals")
  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
  @@index([referralCode])
  @@index([status])
}

model ReferralReward {
  id              Int               @id @default(autoincrement())
  referralId      Int               @map("referral_id")
  
  // Beneficiaire
  userId          Int               @map("user_id")
  userType        String            @map("user_type")
  
  // Recompense
  rewardType      RewardType        @map("reward_type")
  amount          Float?
  description     String?
  
  // Statut
  status          RewardStatus      @default(PENDING)
  
  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  claimedAt       DateTime?         @map("claimed_at")
  expiresAt       DateTime?         @map("expires_at")

  // Relations
  referral        Referral          @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@map("referral_rewards")
  @@index([referralId])
  @@index([userId])
  @@index([status])
}

model ReferralSettings {
  id                      Int       @id @default(autoincrement())
  
  // Configuration
  isActive                Boolean   @default(true) @map("is_active")
  referrerRewardAmount    Float     @default(50) @map("referrer_reward_amount")
  referredRewardAmount    Float     @default(25) @map("referred_reward_amount")
  minContractsToValidate  Int       @default(1) @map("min_contracts_to_validate")
  rewardExpirationDays    Int       @default(90) @map("reward_expiration_days")
  
  // Timestamps
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  @@map("referral_settings")
}
