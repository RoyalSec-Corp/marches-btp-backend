// ============================================
// MarchesBTP - Models Parrainage (MVP2)
// ============================================

model Referral {
  id              Int             @id @default(autoincrement())
  
  // Parrain
  referrerId      Int             @map("referrer_id")
  referrerType    String          @map("referrer_type")
  
  // Filleul
  refereeId       Int             @unique @map("referee_id")
  refereeType     String          @map("referee_type")
  
  // Code utilise
  referralCode    String          @map("referral_code")
  
  // Statut
  status          ReferralStatus  @default(PENDING)
  
  // Validation
  validatedAt     DateTime?       @map("validated_at")
  
  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  referrer        User            @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)
  referee         User            @relation("RefereeRelation", fields: [refereeId], references: [id], onDelete: Cascade)
  rewards         ReferralReward[]

  @@map("referrals")
  @@index([referrerId])
  @@index([refereeId])
  @@index([referralCode])
  @@index([status])
}

model ReferralReward {
  id              Int               @id @default(autoincrement())
  referralId      Int               @map("referral_id")
  
  // Beneficiaire
  userId          Int               @map("user_id")
  userType        String            @map("user_type")
  
  // Recompense
  rewardType      RewardType        @map("reward_type")
  amount          Float?
  description     String?
  
  // Statut
  status          RewardStatus      @default(PENDING)
  
  // Paiement
  paidAt          DateTime?         @map("paid_at")
  
  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")

  // Relations
  referral        Referral          @relation(fields: [referralId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("referral_rewards")
  @@index([referralId])
  @@index([userId])
  @@index([status])
}

model ReferralSettings {
  id                    Int       @id @default(autoincrement())
  
  // Recompenses parrain
  referrerRewardAmount  Float     @map("referrer_reward_amount")
  referrerRewardType    RewardType @map("referrer_reward_type")
  
  // Recompenses filleul
  refereeRewardAmount   Float     @map("referee_reward_amount")
  refereeRewardType     RewardType @map("referee_reward_type")
  
  // Conditions
  minContractsToValidate Int      @default(1) @map("min_contracts_to_validate")
  minAmountToValidate    Float?   @map("min_amount_to_validate")
  
  // Activation
  isActive              Boolean   @default(true) @map("is_active")
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("referral_settings")
}
