// ============================================
// MarchesBTP - Model Litige
// MVP2 : Gestion des conflits
// ============================================

model Litige {
  id                Int           @id @default(autoincrement())
  
  // Reference unique
  reference         String        @unique
  
  // Contrat concerne
  contratId         Int           @map("contrat_id")
  
  // Demandeur
  demandeurId       Int           @map("demandeur_id")
  demandeurType     String        @map("demandeur_type")
  
  // Defendeur
  defendeurId       Int           @map("defendeur_id")
  defendeurType     String        @map("defendeur_type")
  
  // Details
  type              LitigeType
  titre             String
  description       String        @db.Text
  montantLitige     Float?        @map("montant_litige")
  
  // Statut
  statut            LitigeStatus  @default(OUVERT)
  priorite          LitigePriority @default(NORMALE)
  
  // Resolution
  resolution        String?       @db.Text
  montantAccorde    Float?        @map("montant_accorde")
  resolvedBy        Int?          @map("resolved_by")
  resolvedAt        DateTime?     @map("resolved_at")
  
  // Admin assigne
  assignedTo        Int?          @map("assigned_to")
  assignedAt        DateTime?     @map("assigned_at")
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  closedAt          DateTime?     @map("closed_at")

  // Relations
  contrat           Contrat       @relation(fields: [contratId], references: [id], onDelete: Restrict)
  messages          LitigeMessage[]
  documents         LitigeDocument[]

  @@map("litiges")
  @@index([contratId])
  @@index([demandeurId])
  @@index([defendeurId])
  @@index([statut])
  @@index([priorite])
  @@index([assignedTo])
  @@index([createdAt])
}

model LitigeMessage {
  id          Int       @id @default(autoincrement())
  litigeId    Int       @map("litige_id")
  
  // Auteur
  auteurId    Int       @map("auteur_id")
  auteurType  String    @map("auteur_type")
  auteurNom   String    @map("auteur_nom")
  
  // Message
  contenu     String    @db.Text
  isInternal  Boolean   @default(false) @map("is_internal")
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  litige      Litige    @relation(fields: [litigeId], references: [id], onDelete: Cascade)

  @@map("litige_messages")
  @@index([litigeId])
  @@index([auteurId])
  @@index([createdAt])
}

model LitigeDocument {
  id            Int       @id @default(autoincrement())
  litigeId      Int       @map("litige_id")
  
  // Document
  nom           String
  filePath      String    @map("file_path")
  fileSize      Int?      @map("file_size")
  mimeType      String?   @map("mime_type")
  
  // Upload
  uploadedBy    Int       @map("uploaded_by")
  uploadedAt    DateTime  @default(now()) @map("uploaded_at")

  // Relations
  litige        Litige    @relation(fields: [litigeId], references: [id], onDelete: Cascade)

  @@map("litige_documents")
  @@index([litigeId])
}
